<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–‡ç« è¯¦æƒ…</title> <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;700&family=Noto+Sans+SC:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="assets/css/main.css">
    <link rel="stylesheet" href="assets/css/toc.css">
    <style>
        /* é¡µé¢ç‰¹æœ‰å¸ƒå±€ */
        body {
            padding-top: 40px;
        }
        .article-layout {
            display: flex;
            justify-content: center;
            gap: 40px;
            max-width: 1200px;
            margin: 0 auto;
            align-items: flex-start;
        }
        .article-main {
            flex-grow: 1;
            max-width: 800px; /* é™åˆ¶æ–‡ç« æœ€å¤§å®½åº¦ï¼Œä¿è¯é˜…è¯»ä½“éªŒ */
            width: 100%;
        }
        .article-header h1 {
            font-size: 2.8em;
            margin-top: 0;
            margin-bottom: 0.5em;
        }
        .article-content {
            font-size: 16px;
            line-height: 1.8;
            color: var(--text-light);
        }
        /* æ–‡ç« å†…å®¹é‡Œçš„å…ƒç´ æ ·å¼ */
        .article-content h2,
        .article-content h3,
        .article-content h4 {
            scroll-margin-top: 20px; /* ç‚¹å‡»TOCé“¾æ¥è·³è½¬æ—¶ï¼Œæ ‡é¢˜è·ç¦»é¡¶éƒ¨æœ‰20pxé—´è· */
        }
        .article-content h2 { margin-top: 2.5em; padding-bottom: 0.5em; border-bottom: 1px solid var(--border-color); }
        .article-content h3 { margin-top: 2em; }
        .article-content a { color: var(--primary-accent); text-decoration: none; }
        .article-content a:hover { text-decoration: underline; }
        .article-content ul, .article-content ol { padding-left: 25px; }
        .article-content code { background: var(--input-bg); padding: 0.2em 0.4em; border-radius: 4px; font-size: 0.9em; }
        
        /* ä¸Šä¸€ç¯‡/ä¸‹ä¸€ç¯‡å¯¼èˆª */
        .post-navigation {
            margin-top: 60px;
            display: flex;
            justify-content: space-between;
            border-top: 1px solid var(--border-color);
            padding-top: 20px;
        }
        .post-navigation a {
            color: var(--text-medium);
            text-decoration: none;
            max-width: 45%;
        }
        .post-navigation a:hover {
            color: var(--primary-accent);
        }
        .post-navigation .nav-label { font-size: 0.9em; margin-bottom: 5px; }
        .post-navigation .nav-title { font-weight: bold; color: var(--text-light); }

        /* åœ¨å°å±å¹•ä¸Šéšè—ç›®å½• */
        @media (max-width: 1024px) {
            .toc-container { display: none; }
        }
    </style>
</head>
<body data-theme="dark">

    <div class="article-layout">
        <main class="article-main" id="article-main">
            <header class="article-header">
                <a href="blognav.html" style="color: var(--primary-accent); text-decoration: none; font-size: 14px;">&larr; è¿”å›åˆ—è¡¨</a>
                <h1 id="article-title">æ­£åœ¨åŠ è½½...</h1>
                <div class="article-meta" id="article-meta"></div>
            </header>
            
            <article class="article-content" id="article-content">
                </article>

            <nav class="post-navigation" id="post-navigation">
                </nav>
        </main>

        <aside class="toc-container" id="toc-container">
            <h3>ç›®å½•</h3>
            <div class="toc-progress"><div class="toc-progress-bar" id="toc-progress-bar"></div></div>
            <ul class="toc-list" id="toc-list">
                </ul>
        </aside>
    </div>

    <script>
        // /blog/assets/js/theme.js çš„å†…å®¹ (å¤ç”¨)
        class ThemeSync {
            constructor() { this.iframeBody = document.body; this.parentBody = window.parent.document.body; this.init(); }
            syncTheme() {
                const currentTheme = this.parentBody.getAttribute('data-theme') || 'dark';
                this.iframeBody.setAttribute('data-theme', currentTheme);
                const accentColor = window.parent.document.documentElement.style.getPropertyValue('--primary-accent');
                if (accentColor) document.documentElement.style.setProperty('--primary-accent', accentColor);
            }
            init() {
                this.syncTheme();
                const observer = new MutationObserver(() => this.syncTheme());
                observer.observe(this.parentBody, { attributes: true, attributeFilter: ['data-theme'] });
                observer.observe(window.parent.document.documentElement, { attributes: true, attributeFilter: ['style'] });
            }
        }
        new ThemeSync();
    </script>
    <script>
        // /blog/assets/js/toc.js çš„å†…å®¹ (*** å·²ä¿®æ­£ ***)
        class TableOfContents {
            constructor(contentSelector, tocSelector, progressSelector) {
                this.contentEl = document.querySelector(contentSelector);
                this.tocEl = document.querySelector(tocSelector);
                this.progressEl = document.querySelector(progressSelector);
                this.headings = [];
                this.tocLinks = [];
                this.activeTocLink = null;
                // ä½¿ç”¨ requestAnimationFrame è¿›è¡ŒèŠ‚æµï¼Œé¿å…æ»šåŠ¨äº‹ä»¶é¢‘ç¹è§¦å‘å¯¼è‡´æ€§èƒ½é—®é¢˜
                this.ticking = false;
            }

            build() {
                this.tocEl.innerHTML = '';
                // ä»…é€‰æ‹© h2 å’Œ h3ï¼Œä½ å¯ä»¥æŒ‰éœ€æ‰©å±•
                this.headings = Array.from(this.contentEl.querySelectorAll('h2, h3'));
                
                if (this.headings.length === 0) {
                    document.getElementById('toc-container').style.display = 'none';
                    return;
                }

                this.headings.forEach(heading => {
                    if (!heading.id) {
                        heading.id = heading.textContent.trim().toLowerCase().replace(/\s+/g, '-');
                    }
                    
                    const level = heading.tagName.toLowerCase();
                    const listItem = document.createElement('li');
                    listItem.dataset.level = level;

                    const link = document.createElement('a');
                    link.href = `#${heading.id}`;
                    link.textContent = heading.textContent;

                    listItem.appendChild(link);
                    this.tocEl.appendChild(listItem);
                    this.tocLinks.push(listItem); // ä¿å­˜liå…ƒç´ ï¼Œæ–¹ä¾¿æ“ä½œclass
                });
            }
            
            initScrollSync() {
                if (this.headings.length === 0) return;

                window.addEventListener('scroll', () => {
                    if (!this.ticking) {
                        window.requestAnimationFrame(() => {
                            this.updateActiveLink();
                            this.updateProgress();
                            this.ticking = false;
                        });
                        this.ticking = true;
                    }
                });
                
                // åˆå§‹åŠ è½½æ—¶ä¹Ÿæ‰§è¡Œä¸€æ¬¡
                this.updateActiveLink();
                this.updateProgress();
            }
            
            updateActiveLink() {
                // å®šä¹‰ä¸€ä¸ªåˆ¤å®šä¸ºâ€œæœ‰æ•ˆâ€çš„å±å¹•ä½ç½®ï¼Œæ¯”å¦‚å±å¹•é«˜åº¦çš„ 20%
                const scrollY = window.scrollY;
                const threshold = window.innerHeight * 0.2; 
                let currentActiveHeading = null;

                // éå†æ‰€æœ‰æ ‡é¢˜ï¼Œæ‰¾åˆ°æœ€åä¸€ä¸ªå·²ç»æ»šè¿‡é˜ˆå€¼çš„æ ‡é¢˜
                for (const heading of this.headings) {
                    if (heading.getBoundingClientRect().top < threshold) {
                        currentActiveHeading = heading;
                    } else {
                        break; // åé¢çš„æ ‡é¢˜è‚¯å®šæ²¡åˆ°ä½ç½®ï¼Œä¸­æ–­å¾ªç¯ä¼˜åŒ–æ€§èƒ½
                    }
                }
                
                let newActiveTocLink = null;
                if (currentActiveHeading) {
                    newActiveTocLink = this.tocEl.querySelector(`a[href="#${currentActiveHeading.id}"]`)?.parentElement;
                }

                // ä»…å½“æ´»åŠ¨é“¾æ¥å˜åŒ–æ—¶æ‰æ›´æ–°DOMï¼Œé¿å…ä¸å¿…è¦çš„é‡ç»˜
                if (newActiveTocLink !== this.activeTocLink) {
                    if (this.activeTocLink) {
                        this.activeTocLink.classList.remove('active');
                    }
                    if (newActiveTocLink) {
                        newActiveTocLink.classList.add('active');
                    }
                    this.activeTocLink = newActiveTocLink;
                }
            }

            updateProgress() {
                const articleMainEl = document.getElementById('article-main');
                const contentHeight = articleMainEl.scrollHeight;
                const viewportHeight = window.innerHeight;

                // å½“å†…å®¹é«˜åº¦å°äºè§†å£æ—¶ï¼Œä¸è®¡ç®—è¿›åº¦
                if (contentHeight <= viewportHeight) {
                    this.progressEl.style.width = '0%';
                    return;
                }
                
                const scrollableDist = contentHeight - viewportHeight;
                const progress = Math.min(window.scrollY / scrollableDist, 1);
                
                this.progressEl.style.width = `${progress * 100}%`;
            }
        }
    </script>
    <script>
        // /blog/assets/js/article.js çš„å†…å®¹ (æ— é‡å¤§ä¿®æ”¹ï¼Œä¿æŒåŸæ ·)
        document.addEventListener('DOMContentLoaded', () => {
            const titleEl = document.getElementById('article-title');
            const metaEl = document.getElementById('article-meta');
            const contentEl = document.getElementById('article-content');
            const navEl = document.getElementById('post-navigation');

            async function loadArticle() {
                const params = new URLSearchParams(window.location.search);
                const articleId = params.get('id');

                // å¦‚æœURLä¸­æ²¡æœ‰IDï¼Œè·³è½¬åˆ°404
                if (!articleId) {
                    window.location.href = '../404.html';
                    return;
                }
    
                try {
                    const allArticlesRes = await fetch('data/articles.json');
                    const allArticles = await allArticlesRes.json();
                    allArticles.sort((a, b) => new Date(b.date) - new Date(a.date));

                    const articleData = allArticles.find(a => a.id === articleId);

                    // å¦‚æœåœ¨JSONæ•°æ®ä¸­æ‰¾ä¸åˆ°å¯¹åº”çš„æ–‡ç« IDï¼Œè·³è½¬åˆ°404
                    if (!articleData) {
                        window.location.href = '../404.html';
                        return;
                    }

                    const articleHtmlRes = await fetch(articleData.file);
                    // å¦‚æœæ–‡ç« çš„htmlæ–‡ä»¶æœ¬èº«ä¸å­˜åœ¨ï¼Œä¹Ÿè·³è½¬åˆ°404
                    if (!articleHtmlRes.ok) {
                        window.location.href = '../404.html';
                        return;
                    }
                    const articleHtml = await articleHtmlRes.text();
        
                    contentEl.innerHTML = articleHtml;
        
                    document.title = `${articleData.title} - å¾®å…‰åšå®¢`;
                    titleEl.textContent = articleData.title;
                    metaEl.innerHTML = `<span>ğŸ“… ${articleData.date}</span>`;

                    const toc = new TableOfContents('#article-content', '#toc-list', '#toc-progress-bar');
                    toc.build();
                    toc.initScrollSync();

                    const articleIndex = allArticles.findIndex(a => a.id === articleId);
                    const prevArticle = allArticles[articleIndex + 1];
                    const nextArticle = allArticles[articleIndex - 1];

                    navEl.innerHTML = `
                        <div>
                            ${prevArticle ? `
                                <a href="article.html?id=${prevArticle.id}">
                                    <div class="nav-label">ä¸Šä¸€ç¯‡</div>
                                    <div class="nav-title">${prevArticle.title}</div>
                                </a>` : ''}
                        </div>
                        <div style="text-align: right;">
                             ${nextArticle ? `
                                <a href="article.html?id=${nextArticle.id}">
                                    <div class="nav-label">ä¸‹ä¸€ç¯‡</div>
                                    <div class="nav-title">${nextArticle.title}</div>
                                </a>` : ''}
                        </div>
                    `;

                } catch (error) {
                    console.error('åŠ è½½æ–‡ç« å¤±è´¥:', error);
                    contentEl.innerHTML = '<p>åŠ è½½æ–‡ç« æ—¶å‘ç”Ÿç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•ã€‚</p>';
                }
            }

            loadArticle();
        });
    </script>
</body>
</html>
