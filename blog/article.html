<!DOCTYPE html>
<html lang="zh">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>æ–‡ç« è¯¦æƒ…</title>
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link
            href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;700&family=Noto+Sans+SC:wght@400;700&display=swap"
            rel="stylesheet">
        <link rel="stylesheet" href="assets/css/main.css">
        <link rel="stylesheet" href="assets/css/toc.css">

        <!-- Markdown æ¸²æŸ“æ”¯æŒ -->
        <script
            src="https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js"></script>

        <!-- KaTeX æ•°å­¦å…¬å¼æ”¯æŒ -->
        <link rel="stylesheet"
            href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
        <script
            src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
        <script
            src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

        <!-- Highlight.js ä»£ç é«˜äº® -->
        <link rel="stylesheet"
            href="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/styles/github-dark.css">
        <script
            src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/highlight.min.js"></script>
        <style>
        /* é¡µé¢ç‰¹æœ‰å¸ƒå±€ */
        body {
            padding-top: 40px;
        }
        .article-layout {
            display: flex;
            justify-content: center;
            gap: 40px;
            max-width: 1200px;
            margin: 0 auto;
            align-items: flex-start;
        }
        .article-main {
            flex-grow: 1;
            max-width: 800px; /* é™åˆ¶æ–‡ç« æœ€å¤§å®½åº¦ï¼Œä¿è¯é˜…è¯»ä½“éªŒ */
            width: 100%;
        }
        .article-header h1 {
            font-size: 2.8em;
            margin-top: 0;
            margin-bottom: 0.5em;
        }
        .article-content {
            font-size: 16px;
            line-height: 1.8;
            color: var(--text-light);
        }
        /* æ–‡ç« å†…å®¹é‡Œçš„å…ƒç´ æ ·å¼ */
        .article-content h2,
        .article-content h3,
        .article-content h4 {
            scroll-margin-top: 20px; /* ç‚¹å‡»TOCé“¾æ¥è·³è½¬æ—¶ï¼Œæ ‡é¢˜è·ç¦»é¡¶éƒ¨æœ‰20pxé—´è· */
        }
        .article-content h2 { margin-top: 2.5em; padding-bottom: 0.5em; border-bottom: 1px solid var(--border-color); }
        .article-content h3 { margin-top: 2em; }
        .article-content a { color: var(--primary-accent); text-decoration: none; }
        .article-content a:hover { text-decoration: underline; }
        .article-content ul, .article-content ol { padding-left: 25px; }
        .article-content code { background: var(--input-bg); padding: 0.2em 0.4em; border-radius: 4px; font-size: 0.9em; }
        
        /* ä¸Šä¸€ç¯‡/ä¸‹ä¸€ç¯‡å¯¼èˆª */
        .post-navigation {
            margin-top: 60px;
            display: flex;
            justify-content: space-between;
            border-top: 1px solid var(--border-color);
            padding-top: 20px;
        }
        .post-navigation a {
            color: var(--text-medium);
            text-decoration: none;
            max-width: 45%;
        }
        .post-navigation a:hover {
            color: var(--primary-accent);
        }
        .post-navigation .nav-label { font-size: 0.9em; margin-bottom: 5px; }
        .post-navigation .nav-title { font-weight: bold; color: var(--text-light); }

        /* Markdown æ¸²æŸ“å†…å®¹çš„é¢å¤–æ ·å¼ */
        .article-content pre {
            background: var(--input-bg);
            padding: 16px;
            border-radius: 6px;
            overflow-x: auto;
            margin: 16px 0;
        }
        .article-content pre code {
            background: none;
            padding: 0;
            font-family: 'Consolas', 'Monaco', monospace;
        }
        .article-content table {
            border-collapse: collapse;
            width: 100%;
            margin: 16px 0;
        }
        .article-content table th,
        .article-content table td {
            border: 1px solid var(--border-color);
            padding: 10px 13px;
            text-align: left;
        }
        .article-content table th {
            background: var(--input-bg);
            font-weight: 600;
        }
        .article-content blockquote {
            padding: 10px 20px;
            margin: 16px 0;
            color: var(--text-medium);
            border-left: 4px solid var(--primary-accent);
            background: var(--input-bg);
        }
        .article-content img {
            max-width: 100%;
            height: auto;
            border-radius: 4px;
            margin: 16px 0;
        }
        .article-content hr {
            height: 2px;
            background: var(--border-color);
            border: none;
            margin: 24px 0;
        }
        /* KaTeX æ•°å­¦å…¬å¼æ ·å¼ */
        .katex {
            font-size: 1.1em;
        }
        .katex-display {
            margin: 20px 0;
            overflow-x: auto;
            overflow-y: hidden;
        }

        /* åœ¨å°å±å¹•ä¸Šéšè—ç›®å½• */
        @media (max-width: 1024px) {
            .toc-container { display: none; }
        }
    </style>
    </head>
    <body data-theme="dark">

        <div class="article-layout">
            <main class="article-main" id="article-main">
                <header class="article-header">
                    <a href="blognav.html"
                        style="color: var(--primary-accent); text-decoration: none; font-size: 14px;">&larr;
                        è¿”å›åˆ—è¡¨</a>
                    <h1 id="article-title">æ­£åœ¨åŠ è½½...</h1>
                    <div class="article-meta" id="article-meta"></div>
                </header>

                <article class="article-content" id="article-content">
                </article>

                <nav class="post-navigation" id="post-navigation">
                </nav>
            </main>

            <aside class="toc-container" id="toc-container">
                <h3>ç›®å½•</h3>
                <div class="toc-progress"><div class="toc-progress-bar"
                        id="toc-progress-bar"></div></div>
                <ul class="toc-list" id="toc-list">
                </ul>
            </aside>
        </div>

        <script>
        // /blog/assets/js/theme.js çš„å†…å®¹ (å¤ç”¨)
        class ThemeSync {
            constructor() { this.iframeBody = document.body; this.parentBody = window.parent.document.body; this.init(); }
            syncTheme() {
                const currentTheme = this.parentBody.getAttribute('data-theme') || 'dark';
                this.iframeBody.setAttribute('data-theme', currentTheme);
                const accentColor = window.parent.document.documentElement.style.getPropertyValue('--primary-accent');
                if (accentColor) document.documentElement.style.setProperty('--primary-accent', accentColor);
            }
            init() {
                this.syncTheme();
                const observer = new MutationObserver(() => this.syncTheme());
                observer.observe(this.parentBody, { attributes: true, attributeFilter: ['data-theme'] });
                observer.observe(window.parent.document.documentElement, { attributes: true, attributeFilter: ['style'] });
            }
        }
        new ThemeSync();
    </script>
        <script>
        // /blog/assets/js/toc.js çš„å†…å®¹ (*** å·²ä¿®æ­£ ***)
        class TableOfContents {
            constructor(contentSelector, tocSelector, progressSelector) {
                this.contentEl = document.querySelector(contentSelector);
                this.tocEl = document.querySelector(tocSelector);
                this.progressEl = document.querySelector(progressSelector);
                this.headings = [];
                this.tocLinks = [];
                this.activeTocLink = null;
                // ä½¿ç”¨ requestAnimationFrame è¿›è¡ŒèŠ‚æµï¼Œé¿å…æ»šåŠ¨äº‹ä»¶é¢‘ç¹è§¦å‘å¯¼è‡´æ€§èƒ½é—®é¢˜
                this.ticking = false;
            }

            build() {
                this.tocEl.innerHTML = '';
                // ä»…é€‰æ‹© h2 å’Œ h3ï¼Œä½ å¯ä»¥æŒ‰éœ€æ‰©å±•
                this.headings = Array.from(this.contentEl.querySelectorAll('h2, h3'));
                
                if (this.headings.length === 0) {
                    document.getElementById('toc-container').style.display = 'none';
                    return;
                }

                this.headings.forEach(heading => {
                    if (!heading.id) {
                        heading.id = heading.textContent.trim().toLowerCase().replace(/\s+/g, '-');
                    }
                    
                    const level = heading.tagName.toLowerCase();
                    const listItem = document.createElement('li');
                    listItem.dataset.level = level;

                    const link = document.createElement('a');
                    link.href = `#${heading.id}`;
                    link.textContent = heading.textContent;

                    listItem.appendChild(link);
                    this.tocEl.appendChild(listItem);
                    this.tocLinks.push(listItem); // ä¿å­˜liå…ƒç´ ï¼Œæ–¹ä¾¿æ“ä½œclass
                });
            }
            
            initScrollSync() {
                if (this.headings.length === 0) return;

                window.addEventListener('scroll', () => {
                    if (!this.ticking) {
                        window.requestAnimationFrame(() => {
                            this.updateActiveLink();
                            this.updateProgress();
                            this.ticking = false;
                        });
                        this.ticking = true;
                    }
                });
                
                // åˆå§‹åŠ è½½æ—¶ä¹Ÿæ‰§è¡Œä¸€æ¬¡
                this.updateActiveLink();
                this.updateProgress();
            }
            
            updateActiveLink() {
                // å®šä¹‰ä¸€ä¸ªåˆ¤å®šä¸ºâ€œæœ‰æ•ˆâ€çš„å±å¹•ä½ç½®ï¼Œæ¯”å¦‚å±å¹•é«˜åº¦çš„ 20%
                const scrollY = window.scrollY;
                const threshold = window.innerHeight * 0.2; 
                let currentActiveHeading = null;

                // éå†æ‰€æœ‰æ ‡é¢˜ï¼Œæ‰¾åˆ°æœ€åä¸€ä¸ªå·²ç»æ»šè¿‡é˜ˆå€¼çš„æ ‡é¢˜
                for (const heading of this.headings) {
                    if (heading.getBoundingClientRect().top < threshold) {
                        currentActiveHeading = heading;
                    } else {
                        break; // åé¢çš„æ ‡é¢˜è‚¯å®šæ²¡åˆ°ä½ç½®ï¼Œä¸­æ–­å¾ªç¯ä¼˜åŒ–æ€§èƒ½
                    }
                }
                
                let newActiveTocLink = null;
                if (currentActiveHeading) {
                    newActiveTocLink = this.tocEl.querySelector(`a[href="#${currentActiveHeading.id}"]`)?.parentElement;
                }

                // ä»…å½“æ´»åŠ¨é“¾æ¥å˜åŒ–æ—¶æ‰æ›´æ–°DOMï¼Œé¿å…ä¸å¿…è¦çš„é‡ç»˜
                if (newActiveTocLink !== this.activeTocLink) {
                    if (this.activeTocLink) {
                        this.activeTocLink.classList.remove('active');
                    }
                    if (newActiveTocLink) {
                        newActiveTocLink.classList.add('active');
                    }
                    this.activeTocLink = newActiveTocLink;
                }
            }

            updateProgress() {
                const articleMainEl = document.getElementById('article-main');
                const contentHeight = articleMainEl.scrollHeight;
                const viewportHeight = window.innerHeight;

                // å½“å†…å®¹é«˜åº¦å°äºè§†å£æ—¶ï¼Œä¸è®¡ç®—è¿›åº¦
                if (contentHeight <= viewportHeight) {
                    this.progressEl.style.width = '0%';
                    return;
                }
                
                const scrollableDist = contentHeight - viewportHeight;
                const progress = Math.min(window.scrollY / scrollableDist, 1);
                
                this.progressEl.style.width = `${progress * 100}%`;
            }
        }
    </script>
        <script>
        // /blog/assets/js/article.js çš„å†…å®¹ (*** å·²å¢å¼ºæ”¯æŒ Markdown ***)
        
        // æ•°å­¦å…¬å¼å ä½ç¬¦å­˜å‚¨
        let mathPlaceholders = [];
        
        // é¢„å¤„ç†ï¼šæå–å¹¶ä¿æŠ¤æ•°å­¦å…¬å¼
        function protectMath(markdown) {
            mathPlaceholders = [];
            let counter = 0;
            
            // ä¿æŠ¤å—çº§å…¬å¼ $$...$$
            markdown = markdown.replace(/\$\$[\s\S]*?\$\$/g, (match) => {
                const placeholder = `MATH_BLOCK_${counter++}`;
                mathPlaceholders.push({ placeholder, content: match });
                return placeholder;
            });
            
            // ä¿æŠ¤è¡Œå†…å…¬å¼ $...$
            markdown = markdown.replace(/\$([^\$\n]+?)\$/g, (match) => {
                const placeholder = `MATH_INLINE_${counter++}`;
                mathPlaceholders.push({ placeholder, content: match });
                return placeholder;
            });
            
            // ä¿æŠ¤ \[...\] å’Œ \(...\)
            markdown = markdown.replace(/\\\[[\s\S]*?\\\]/g, (match) => {
                const placeholder = `MATH_BRACKET_${counter++}`;
                mathPlaceholders.push({ placeholder, content: match });
                return placeholder;
            });
            
            markdown = markdown.replace(/\\\([\s\S]*?\\\)/g, (match) => {
                const placeholder = `MATH_PAREN_${counter++}`;
                mathPlaceholders.push({ placeholder, content: match });
                return placeholder;
            });
            
            return markdown;
        }
        
        // åå¤„ç†ï¼šæ¢å¤æ•°å­¦å…¬å¼
        function restoreMath(html) {
            mathPlaceholders.forEach(({ placeholder, content }) => {
                html = html.replace(new RegExp(placeholder, 'g'), content);
            });
            return html;
        }
        
        // é…ç½® Marked.js
        if (typeof marked !== 'undefined') {
            marked.setOptions({
                breaks: true,
                gfm: true,
                headerIds: true,
                mangle: false
            });
            
            // è‡ªå®šä¹‰æ¸²æŸ“å™¨
            const renderer = new marked.Renderer();
            renderer.heading = function(text, level) {
                const id = text.toLowerCase()
                    .replace(/[^\w\u4e00-\u9fa5]+/g, '-')
                    .replace(/^-+|-+$/g, '');
                return `<h${level} id="${id}">${text}</h${level}>`;
            };
            marked.use({ renderer });
        }
        
        // æ¸²æŸ“ Markdown å†…å®¹
        function renderMarkdown(markdown) {
            // é¢„å¤„ç†ï¼šä¿æŠ¤æ•°å­¦å…¬å¼
            markdown = protectMath(markdown);
            
            // è½¬æ¢ Markdown ä¸º HTML
            let html = marked.parse(markdown);
            
            // åå¤„ç†ï¼šæ¢å¤æ•°å­¦å…¬å¼
            html = restoreMath(html);
            
            return html;
        }
        
        // åº”ç”¨æ•°å­¦å…¬å¼å’Œä»£ç é«˜äº®
        function applyEnhancements() {
            const contentEl = document.getElementById('article-content');
            
            // æ¸²æŸ“æ•°å­¦å…¬å¼
            if (typeof renderMathInElement !== 'undefined') {
                renderMathInElement(contentEl, {
                    delimiters: [
                        {left: '$$', right: '$$', display: true},
                        {left: '$', right: '$', display: false},
                        {left: '\\[', right: '\\]', display: true},
                        {left: '\\(', right: '\\)', display: false}
                    ],
                    throwOnError: false
                });
            }
            
            // ä»£ç é«˜äº®
            if (typeof hljs !== 'undefined') {
                contentEl.querySelectorAll('pre code').forEach((block) => {
                    hljs.highlightElement(block);
                });
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            const titleEl = document.getElementById('article-title');
            const metaEl = document.getElementById('article-meta');
            const contentEl = document.getElementById('article-content');
            const navEl = document.getElementById('post-navigation');

            async function loadArticle() {
                const params = new URLSearchParams(window.location.search);
                const articleId = params.get('id');

                // å¦‚æœURLä¸­æ²¡æœ‰IDï¼Œè·³è½¬åˆ°404
                if (!articleId) {
                    window.location.href = '../404.html';
                    return;
                }
    
                try {
                    const allArticlesRes = await fetch('data/articles.json');
                    const allArticles = await allArticlesRes.json();
                    allArticles.sort((a, b) => new Date(b.date) - new Date(a.date));

                    const articleData = allArticles.find(a => a.id === articleId);

                    // å¦‚æœåœ¨JSONæ•°æ®ä¸­æ‰¾ä¸åˆ°å¯¹åº”çš„æ–‡ç« IDï¼Œè·³è½¬åˆ°404
                    if (!articleData) {
                        window.location.href = '../404.html';
                        return;
                    }

                    const articleFileRes = await fetch(articleData.file);
                    // å¦‚æœæ–‡ç« æ–‡ä»¶æœ¬èº«ä¸å­˜åœ¨ï¼Œä¹Ÿè·³è½¬åˆ°404
                    if (!articleFileRes.ok) {
                        window.location.href = '../404.html';
                        return;
                    }
                    
                    const articleContent = await articleFileRes.text();
                    
                    // æ£€æµ‹æ–‡ä»¶ç±»å‹ï¼šæ ¹æ®æ–‡ä»¶æ‰©å±•ååˆ¤æ–­
                    const isMarkdown = articleData.file.endsWith('.md');
                    
                    if (isMarkdown) {
                        // Markdown æ–‡ä»¶ï¼šæ¸²æŸ“åæ’å…¥
                        const renderedHtml = renderMarkdown(articleContent);
                        contentEl.innerHTML = renderedHtml;
                        
                        // åº”ç”¨æ•°å­¦å…¬å¼å’Œä»£ç é«˜äº®
                        applyEnhancements();
                    } else {
                        // HTML æ–‡ä»¶ï¼šç›´æ¥æ’å…¥
                        contentEl.innerHTML = articleContent;
                    }
        
                    document.title = `${articleData.title} - å¾®å…‰åšå®¢`;
                    titleEl.textContent = articleData.title;
                    metaEl.innerHTML = `<span>ğŸ“… ${articleData.date}</span>`;

                    // ç”Ÿæˆç›®å½•
                    const toc = new TableOfContents('#article-content', '#toc-list', '#toc-progress-bar');
                    toc.build();
                    toc.initScrollSync();

                    // ä¸Šä¸€ç¯‡/ä¸‹ä¸€ç¯‡å¯¼èˆª
                    const articleIndex = allArticles.findIndex(a => a.id === articleId);
                    const prevArticle = allArticles[articleIndex + 1];
                    const nextArticle = allArticles[articleIndex - 1];

                    navEl.innerHTML = `
                        <div>
                            ${prevArticle ? `
                                <a href="article.html?id=${prevArticle.id}">
                                    <div class="nav-label">ä¸Šä¸€ç¯‡</div>
                                    <div class="nav-title">${prevArticle.title}</div>
                                </a>` : ''}
                        </div>
                        <div style="text-align: right;">
                             ${nextArticle ? `
                                <a href="article.html?id=${nextArticle.id}">
                                    <div class="nav-label">ä¸‹ä¸€ç¯‡</div>
                                    <div class="nav-title">${nextArticle.title}</div>
                                </a>` : ''}
                        </div>
                    `;

                } catch (error) {
                    console.error('åŠ è½½æ–‡ç« å¤±è´¥:', error);
                    contentEl.innerHTML = '<p>åŠ è½½æ–‡ç« æ—¶å‘ç”Ÿç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•ã€‚</p>';
                }
            }

            loadArticle();
        });
    </script>
    </body>
</html>
