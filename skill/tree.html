<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ShimmerOS - èƒ½åŠ›ç§‘æŠ€ç½‘</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Exo+2:wght@300;400;500;700&family=Noto+Sans+SC:wght@300;400;500&display=swap" rel="stylesheet">
    <style>
        /* --- è®¾è®¡å˜é‡ä¸å…¨å±€æ ·å¼ --- */
        :root {
            --ds-color: #00b8d4; /* æ•°æ®ç§‘å­¦ */
            --ef-color: #00c853; /* ç»æµé‡‘è */
            --bm-color: #ffab00; /* å•†ä¸šç®¡ç† */
            --gs-color: #d500f9; /* é€šç”¨æŠ€èƒ½ */
            --core-color: #fafafa;
            
            --bg-color-dark: #0d1117;
            --bg-color-light: #161b22;
            --text-color: #e6edf3;
            --text-color-muted: #8b949e;
            --border-color: #30363d;
            --transition-speed-fast: 0.2s;
            --transition-speed-med: 0.5s;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { height: 100%; overflow: hidden; }

        body {
            background-color: var(--bg-color-dark);
            color: var(--text-color);
            font-family: 'Exo 2', 'Noto Sans SC', sans-serif;
            display: flex;
            flex-direction: column;
            font-weight: 300;
        }

        /* --- å¤´éƒ¨ --- */
        header {
            padding: 1rem 1.5rem; text-align: center;
            background: rgba(13, 17, 23, 0.7); backdrop-filter: blur(5px);
            border-bottom: 1px solid var(--border-color); z-index: 10;
        }
        h1 {
            font-size: 1.8rem; margin-bottom: 0.25rem; font-weight: 700;
            background: linear-gradient(90deg, var(--ds-color), var(--ef-color), var(--bm-color), var(--gs-color));
            -webkit-background-clip: text; background-clip: text; color: transparent;
            letter-spacing: 1px;
        }
        .subtitle { font-size: 0.85rem; color: var(--text-color-muted); font-weight: 400; }

        /* --- æ ¸å¿ƒå¸ƒå±€ --- */
        .container { display: flex; flex: 1; overflow: hidden; position: relative; }
        #skills-graph {
            flex: 1;
            background-image: 
                radial-gradient(circle at center, rgba(139, 148, 158, 0.08) 0%, transparent 60%),
                linear-gradient(rgba(139, 148, 158, 0.1) 1px, transparent 1px),
                linear-gradient(90deg, rgba(139, 148, 158, 0.1) 1px, transparent 1px);
            background-size: 100% 100%, 30px 30px, 30px 30px;
            background-position: center center; cursor: grab;
        }
        #skills-graph:active { cursor: grabbing; }

        /* --- è¯¦æƒ…é¢æ¿ (æ¡Œé¢ç«¯ä¸ºä¾§è¾¹æ ) --- */
        .detail-panel {
            position: absolute; /* é»˜è®¤ç»å¯¹å®šä½ï¼Œæ–¹ä¾¿å“åº”å¼åˆ‡æ¢ */
            top: 0; right: 0;
            width: 380px; height: 100%;
            background: rgba(22, 27, 34, 0.85); backdrop-filter: blur(10px);
            border-left: 1px solid var(--border-color); padding: 1.5rem;
            overflow-y: auto;
            transform: translateX(100%);
            transition: transform 0.5s cubic-bezier(0.23, 1, 0.32, 1);
            box-shadow: -10px 0 25px rgba(0, 0, 0, 0.5); z-index: 20;
        }
        .detail-panel.visible { transform: translateX(0); }

        .detail-panel h2 {
            margin-bottom: 1.5rem; font-size: 1.6rem; font-weight: 500;
            border-bottom: 1px solid; padding-bottom: 0.8rem;
            display: flex; align-items: center;
        }
        .detail-panel h2::before {
            content: ''; width: 6px; height: 24px;
            border-radius: 3px; margin-right: 12px; background: currentColor;
        }
        .detail-item { margin-bottom: 1.5rem; }
        .detail-item h3 { font-size: 1.1rem; margin-bottom: 0.8rem; color: var(--text-color); font-weight: 400; }
        .detail-item ul { list-style: none; }
        .detail-item li {
            margin-bottom: 0.5rem; line-height: 1.6; color: var(--text-color-muted);
            padding-left: 1.2rem; position: relative;
        }
        .detail-item li::before { content: 'Â»'; position: absolute; left: 0; color: currentColor; opacity: 0.6; }
        .tag-container { margin-top: 1.5rem; }
        .tag {
            display: inline-block; padding: 0.3rem 0.8rem;
            border-radius: 15px; font-size: 0.8rem;
            margin: 0 0.5rem 0.5rem 0; border: 1px solid;
            background-color: rgba(255, 255, 255, 0.05); font-weight: 500;
        }
        .close-btn {
            position: absolute; top: 1.5rem; right: 1.5rem;
            background: none; border: none; font-size: 1.5rem;
            color: var(--text-color-muted); cursor: pointer;
            transition: color var(--transition-speed-fast), transform var(--transition-speed-fast);
        }
        .close-btn:hover { color: var(--text-color); transform: rotate(90deg); }

        /* --- èƒŒæ™¯é®ç½© --- */
        .panel-backdrop {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.5); z-index: 15;
            opacity: 0; pointer-events: none;
            transition: opacity var(--transition-speed-med) ease;
        }
        .panel-backdrop.visible { opacity: 1; pointer-events: auto; }

        /* --- ç­›é€‰å™¨ --- */
        .filters {
            display: flex; flex-wrap: wrap; justify-content: center; gap: 0.5rem 1rem;
            padding: 0.8rem; background: var(--bg-color-dark);
            border-bottom: 1px solid var(--border-color); z-index: 10;
        }
        .filter-btn {
            padding: 0.5rem 1.2rem; border: 1px solid; border-radius: 20px;
            background: transparent; cursor: pointer;
            transition: all var(--transition-speed-fast) ease; font-family: 'Exo 2', sans-serif;
            font-weight: 500; font-size: 0.9rem;
        }
        .filter-btn:hover, .filter-btn.active {
            transform: translateY(-2px);
            box-shadow: 0 0 15px -2px currentColor;
            background: currentColor; color: var(--bg-color-dark) !important;
        }
        .filter-all { border-color: var(--text-color-muted); color: var(--text-color-muted); }
        .filter-ds { border-color: var(--ds-color); color: var(--ds-color); }
        .filter-ef { border-color: var(--ef-color); color: var(--ef-color); }
        .filter-bm { border-color: var(--bm-color); color: var(--bm-color); }
        .filter-gs { border-color: var(--gs-color); color: var(--gs-color); }
        
        /* --- SVG å…ƒç´ æ ·å¼ --- */
        .link { stroke: var(--border-color); stroke-width: 1px; transition: all var(--transition-speed-med) ease; }
        .link.cross-discipline { stroke-dasharray: 4 2; }
        .link.is-highlighted { stroke-width: 2.5px; }

        .node { cursor: pointer; transition: opacity var(--transition-speed-med) ease; }
        .node-shape { stroke-width: 1.5px; fill-opacity: 0.15; transition: all var(--transition-speed-fast) ease; }
        .node:hover .node-shape, .node.is-focused .node-shape { transform: scale(1.1); stroke-width: 3px; fill-opacity: 0.3; }
        .node.is-pinned .node-shape { stroke-width: 3px; stroke-dasharray: 5 2; animation: pulse-stroke 2s infinite; }
        @keyframes pulse-stroke { 50% { stroke-opacity: 0.5; } }

        .node-text {
            font-size: 12px; text-anchor: middle; pointer-events: none;
            fill: var(--text-color-muted); font-weight: 400;
            transition: all var(--transition-speed-fast) ease;
            text-shadow: 0 0 5px rgba(0,0,0,0.9), 0 0 8px rgba(0,0,0,0.9);
        }
        .node-branch .node-text { font-size: 14px; }
        .node-core .node-text { font-size: 20px; }
        .node:hover .node-text, .node.is-focused .node-text { font-weight: 700; fill: #fff; }

        /* --- äº¤äº’æ§ä»¶ --- */
        .controls {
            position: absolute; bottom: 20px; right: 20px;
            display: flex; flex-direction: column; gap: 10px; z-index: 5;
            transition: right var(--transition-speed-med) cubic-bezier(0.23, 1, 0.32, 1);
        }
        body.panel-visible .controls { right: 400px; } /* æ¡Œé¢ç«¯ panel å±•å¼€æ—¶ï¼Œå‘å·¦ç§»åŠ¨ */
        .control-btn {
            width: 40px; height: 40px; border-radius: 50%;
            background: rgba(30, 35, 45, 0.8); border: 1px solid var(--border-color);
            color: white; font-size: 1.5rem; display: flex;
            align-items: center; justify-content: center; cursor: pointer;
            transition: all var(--transition-speed-fast) ease; backdrop-filter: blur(5px);
        }
        .control-btn:hover { background: rgba(50, 55, 65, 0.9); transform: scale(1.1); }

        /* --- å“åº”å¼è®¾è®¡ (çª„å±ä¼˜åŒ–) --- */
        @media (max-width: 768px) {
            h1 { font-size: 1.5rem; }
            .subtitle { font-size: 0.8rem; }
            
            /* è¯¦æƒ…é¢æ¿å˜ä¸ºåº•éƒ¨æŠ½å±‰ */
            .detail-panel {
                top: auto; bottom: 0; left: 0;
                width: 100%; height: auto; max-height: 60vh; /* æœ€å¤§é«˜åº¦ä¸ºè§†å£çš„60% */
                border-left: none; border-top: 1px solid var(--border-color);
                transform: translateY(100%);
                box-shadow: 0 -10px 25px rgba(0, 0, 0, 0.5);
            }
            .detail-panel.visible { transform: translateY(0); }

            /* æ§ä»¶ä½ç½®åœ¨çª„å±ä¸‹ä¿æŒä¸å˜ */
            body.panel-visible .controls { right: 20px; }
        }

    </style>
</head>
<body>
    <header>
        <h1>Shimmer çš„èƒ½åŠ›ç§‘æŠ€ç½‘</h1>
        <p class="subtitle">å¤§æ•°æ®ç®¡ç† Ã— ä¼ä¸šå®¶ç²¾ç¥ Ã— æŠ€æœ¯ç®¡ç†</p>
    </header>
    
    <div class="filters">
        <button class="filter-btn filter-all active" data-category="all">å…¨éƒ¨å±•ç¤º</button>
        <button class="filter-btn filter-ds" data-category="ds">æ•°æ®ç§‘å­¦</button>
        <button class="filter-btn filter-ef" data-category="ef">ç»æµé‡‘è</button>
        <button class="filter-btn filter-bm" data-category="bm">å•†ä¸šç®¡ç†</button>
        <button class="filter-btn filter-gs" data-category="gs">é€šç”¨æŠ€èƒ½</button>
    </div>
    
    <div class="container">
        <div id="skills-graph"></div>
        <div id="panel-backdrop" class="panel-backdrop"></div>
        <div class="detail-panel" id="detail-panel"></div>
    </div>
    
    <div class="controls">
        <div class="control-btn" id="zoom-in" title="æ”¾å¤§">+</div>
        <div class="control-btn" id="zoom-out" title="ç¼©å°">-</div>
        <div class="control-btn" id="reset-view" title="é‡ç½®è§†å›¾">â†º</div>
        <div class="control-btn" id="unpin-all" title="è§£é”æ‰€æœ‰å›ºå®šçš„èŠ‚ç‚¹">ğŸ”“</div>
    </div>

    <script>
        const skillsData = {
            nodes: [
                { id: "shimmer", name: "Shimmer", type: "core" },
                { id: "data-science", name: "æ•°æ®ç§‘å­¦", type: "branch", category: "ds" },
                { id: "econ-finance", name: "ç»æµé‡‘è", type: "branch", category: "ef" },
                { id: "business-mgmt", name: "å•†ä¸šç®¡ç†", type: "branch", category: "bm" },
                { id: "general-skills", name: "é€šç”¨æŠ€èƒ½", type: "branch", category: "gs" },
                { id: "python", name: "Pythonç¨‹åºè®¾è®¡", type: "leaf", category: "ds" },
                { id: "stats", name: "æ•°ç†ç»Ÿè®¡", type: "leaf", category: "ds" },
                { id: "ml", name: "æœºå™¨å­¦ä¹ ", type: "leaf", category: "ds" },
                { id: "data-mining", name: "æ•°æ®æŒ–æ˜", type: "leaf", category: "ds", detail: { title: "æ•°æ®æŒ–æ˜", courses: ["ç»Ÿè®¡æœºå™¨å­¦ä¹ ä¸æ–‡æœ¬æŒ–æ˜ (91)", "å•†åŠ¡æ™ºèƒ½åˆ†æ (87)"], projects: "æ–‡æœ¬æŒ–æ˜ä¸æ–‡çŒ®åˆ†æï¼šä»¥'é“¶å‘ç»æµ'é¢†åŸŸä¸ºä¾‹", experience: "ä¾æ‰˜å…¬å¼€æ•°æ®è¿›è¡Œæ–‡æœ¬é¢„å¤„ç†ã€æ–‡æœ¬è¡¨ç¤ºã€æ–‡æœ¬åˆ†ç±»å’Œä¸»é¢˜åˆ†æç­‰ã€‚" }},
                { id: "db", name: "æ•°æ®åº“åŸç†", type: "leaf", category: "ds" },
                { id: "bigdata-arch", name: "å¤§æ•°æ®æ¶æ„", type: "leaf", category: "ds" },
                { id: "micro-econ", name: "å¾®è§‚ç»æµå­¦", type: "leaf", category: "ef" },
                { id: "macro-econ", "name": "å®è§‚ç»æµå­¦", type: "leaf", category: "ef" },
                { id: "finance", name: "é‡‘èå­¦", type: "leaf", category: "ef", detail: { title: "é‡‘èå­¦", courses: ["é‡‘èå­¦å¯¼è®º"], projects: "Aè‚¡å¸‚åœºçš„å› å­æŠ•èµ„å®è§‚é£é™©æš´éœ²ç ”ç©¶", experience: "ç‹¬ç«‹å®Œæˆå› å­æ„å»ºã€å®è§‚æ•°æ®é€‰å–ã€æŠ•èµ„ç»„åˆæ„å»ºä¸é£é™©ç®¡ç†å…¨åˆ†ææµç¨‹ã€‚" }},
                { id: "time-series", name: "æ—¶åºåˆ†æ", type: "leaf", category: "ef", also: "ds" },
                { id: "scm", name: "ä¾›åº”é“¾ç®¡ç†", type: "leaf", category: "bm" },
                { id: "mis", name: "ç®¡ç†ä¿¡æ¯ç³»ç»Ÿ", type: "leaf", category: "bm" },
                { id: "mgmt-principle", name: "ç®¡ç†å­¦åŸç†", type: "leaf", category: "bm" },
                { id: "managerial-accounting", name: "ç®¡ç†ä¼šè®¡", type: "leaf", category: "bm" },
                { id: "financial-accounting", name: "è´¢åŠ¡ä¼šè®¡", type: "leaf", category: "bm" },
                { id: "erp", name: "ERPç³»ç»Ÿ", type: "leaf", category: "bm" },
                { id: "english", name: "è‹±è¯­", type: "leaf", category: "gs", detail: { title: "è‹±è¯­", achievements: ["å…¨å›½å¤§å­¦ç”Ÿè‹±è¯­å¤§èµ›å›½å®¶äºŒç­‰å¥–", "ä¸­å›½å¤§å­¦ç”Ÿè‹±è¯­è¾©è®ºèµ›å…¨å›½äºŒç­‰å¥–"], certificates: ["IELTS (7.0)", "CET-6 (577)"] }},
                { id: "ms-office", name: "MS Office", type: "leaf", category: "gs" },
                { id: "latex", name: "LaTeX", type: "leaf", category: "gs" },
                { id: "adobe-au", name: "Adobe AU", type: "leaf", category: "gs" }
            ],
            links: [
                { source: "shimmer", target: "data-science" }, { source: "shimmer", target: "econ-finance" }, { source: "shimmer", target: "business-mgmt" }, { source: "shimmer", target: "general-skills" },
                { source: "data-science", target: "python" }, { source: "data-science", target: "stats" }, { source: "data-science", target: "ml" }, { source: "data-science", target: "data-mining" }, { source: "data-science", target: "db" }, { source: "data-science", target: "bigdata-arch" }, { source: "ml", target: "data-mining" }, { source: "stats", target: "data-mining" },
                { source: "econ-finance", target: "micro-econ" }, { source: "econ-finance", target: "macro-econ" }, { source: "econ-finance", target: "finance" }, { source: "econ-finance", target: "time-series" }, { source: "macro-econ", target: "finance" },
                { source: "business-mgmt", target: "scm" }, { source: "business-mgmt", target: "mis" }, { source: "business-mgmt", target: "mgmt-principle" }, { source: "business-mgmt", target: "managerial-accounting" }, { source: "business-mgmt", target: "financial-accounting" }, { source: "business-mgmt", target: "erp" }, { source: "mis", target: "erp" },
                { source: "general-skills", target: "english" }, { source: "general-skills", target: "ms-office" }, { source: "general-skills", target: "latex" }, { source: "general-skills", target: "adobe-au" },
                { source: "data-science", target: "time-series", type: "cross-discipline" }
            ]
        };

        document.addEventListener('DOMContentLoaded', function() {
            // --- é…ç½®é¡¹ ---
            const CONFIG = {
                colors: { ds: 'var(--ds-color)', ef: 'var(--ef-color)', bm: 'var(--bm-color)', gs: 'var(--gs-color)', core: 'var(--core-color)' },
                radii: { core: 60, branch: 45, leaf: 35 },
                forces: { charge: -450, linkDistance: { core: 250, branch: 120, leaf: 70 }, radialStrength: 0.8 }
            };

            // --- å…¨å±€å˜é‡ ---
            const graphContainer = document.getElementById('skills-graph');
            const detailPanel = document.getElementById('detail-panel');
            const backdrop = document.getElementById('panel-backdrop');
            let width = graphContainer.clientWidth, height = graphContainer.clientHeight;
            let simulation, svg, g, link, node, zoom, initialTransform;
            let currentFilter = 'all';

            // --- åˆå§‹åŒ–æµç¨‹ ---
            initGraph();
            initSimulation();
            drawElements();
            setupInteractions();
            initAnimations();

            // --- 1. åˆå§‹åŒ–SVGç”»å¸ƒ ---
            function initGraph() {
                svg = d3.select('#skills-graph').append('svg').attr('width', '100%').attr('height', '100%');
                g = svg.append('g');
                // ä¸ºè·¨å­¦ç§‘èŠ‚ç‚¹å®šä¹‰æ¸å˜è‰²
                const defs = svg.append('defs');
                const tsGradient = defs.append('linearGradient').attr('id', 'grad-time-series').attr('gradientTransform', 'rotate(45)');
                tsGradient.append('stop').attr('offset', '0%').attr('stop-color', CONFIG.colors.ds);
                tsGradient.append('stop').attr('offset', '100%').attr('stop-color', CONFIG.colors.ef);
            }

            // --- 2. åˆå§‹åŒ–åŠ›å¯¼å‘æ¨¡æ‹Ÿ ---
            function initSimulation() {
                simulation = d3.forceSimulation(skillsData.nodes)
                    .force('link', d3.forceLink(skillsData.links).id(d => d.id)
                        .distance(d => CONFIG.forces.linkDistance[d.source.type] || CONFIG.forces.linkDistance.leaf).strength(1))
                    .force('charge', d3.forceManyBody().strength(CONFIG.forces.charge))
                    .force('collision', d3.forceCollide().radius(d => getNodeRadius(d) + 10))
                    .force('radial', d3.forceRadial(d => d.type === 'branch' ? CONFIG.forces.linkDistance.core : 0)
                        .strength(d => d.type === 'branch' ? CONFIG.forces.radialStrength : 0))
                    .force('center', d3.forceCenter(0, 0));
            }

            // --- 3. ç»˜åˆ¶SVGå…ƒç´  ---
            function drawElements() {
                link = g.append('g').selectAll('line').data(skillsData.links).enter()
                    .append('line').attr('class', d => d.type === 'cross-discipline' ? 'link cross-discipline' : 'link');

                node = g.append('g').selectAll('g').data(skillsData.nodes).enter()
                    .append('g').attr('class', d => `node node-${d.type} node-${d.category || 'core'}`);

                node.append('polygon').attr('class', 'node-shape')
                    .attr('points', d => getHexagonPoints(getNodeRadius(d)))
                    .attr('stroke', d => CONFIG.colors[d.category || 'core'])
                    .attr('fill', d => d.id === 'time-series' ? 'url(#grad-time-series)' : CONFIG.colors[d.category || 'core']);

                const text = node.append('text').attr('class', 'node-text').attr('dy', '0.3em');
                text.each(function(d) { wrapText(d3.select(this), d.name, getNodeRadius(d) * 1.6); });

                simulation.on('tick', () => {
                    link.attr('x1', d => d.source.x).attr('y1', d => d.source.y)
                        .attr('x2', d => d.target.x).attr('y2', d => d.target.y);
                    node.attr('transform', d => `translate(${d.x}, ${d.y})`);
                });
            }
            
            // --- 4. è®¾ç½®æ‰€æœ‰äº¤äº’äº‹ä»¶ ---
            function setupInteractions() {
                // ç¼©æ”¾ä¸æ‹–æ‹½
                zoom = d3.zoom().scaleExtent([0.3, 5]).on('zoom', (event) => g.attr('transform', event.transform));
                updateViewBox(); // åˆå§‹è®¾ç½®

                // èŠ‚ç‚¹äº¤äº’
                node.on('click', handleNodeClick)
                    .on('dblclick', handleNodeDblClick)
                    .on('mouseover', handleMouseOver)
                    .on('mouseout', resetFocus);
                
                svg.on('click', () => { hideDetails(); resetFocus(); });
                
                node.call(d3.drag().on('start', dragstarted).on('drag', dragged).on('end', dragended));

                // æ§ä»¶ä¸ç­›é€‰å™¨
                setupControls();
                setupFilters();

                // å“åº”å¼å¤„ç†
                window.addEventListener('resize', debounce(handleResize, 200));
            }

            // --- 5. å…¥åœºåŠ¨ç”» ---
            function initAnimations() {
                node.style('opacity', 0).attr('transform', 'scale(0.5)');
                node.transition().duration(800).delay((d, i) => i * 15)
                    .style('opacity', 1).attr('transform', 'scale(1)');
            }

            // --- äº‹ä»¶å¤„ç†å‡½æ•° ---
            function handleNodeClick(event, d) { event.stopPropagation(); showDetails(d); focusOnNode(d); }
            function handleNodeDblClick(event, d) {
                event.stopPropagation(); d.fx = d.fx ? null : d.x; d.fy = d.fy ? null : d.y;
                d3.select(this).classed('is-pinned', !!d.fx);
                simulation.alpha(0.1).restart();
            }
            function handleMouseOver(event, d) {
                const connectedIds = new Set([d.id]);
                skillsData.links.forEach(l => { if (l.source.id === d.id) connectedIds.add(l.target.id); if (l.target.id === d.id) connectedIds.add(l.source.id); });
                node.style('opacity', n => (currentFilter !== 'all' && !isVisible(n, currentFilter)) ? 0.1 : (connectedIds.has(n.id) ? 1 : 0.2));
                link.style('stroke-opacity', l => (l.source.id === d.id || l.target.id === d.id) ? 1 : 0.1)
                    .classed('is-highlighted', l => l.source.id === d.id || l.target.id === d.id)
                    .style('stroke', l => { if (l.source.id === d.id || l.target.id === d.id) return CONFIG.colors[d.category || 'core']; return null; });
            }
            function dragstarted(event, d) { if (!event.active) simulation.alphaTarget(0.3).restart(); d.fx = d.x; d.fy = d.y; }
            function dragged(event, d) { d.fx = event.x; d.fy = event.y; }
            function dragended(event, d) { if (!event.active) simulation.alphaTarget(0); if (!d3.select(this).classed('is-pinned')) { d.fx = null; d.fy = null; } }

            // --- æ ¸å¿ƒåŠŸèƒ½å‡½æ•° ---
            function showDetails(d) {
                if (!d.detail) { hideDetails(); return; }
                document.body.classList.add('panel-visible');
                backdrop.classList.add('visible');
                const categoryColorVar = CONFIG.colors[d.category || 'core'];
                detailPanel.style.color = categoryColorVar;
                
                let html = `<button class="close-btn" id="close-detail-btn">Ã—</button><h2>${d.detail.title}</h2>`;
                const detailMap = { courses: 'ç›¸å…³è¯¾ç¨‹', projects: 'é¡¹ç›®ç»éªŒ', experience: 'ç»å†è¯¦æƒ…', achievements: 'ç«èµ›æˆæœ', certificates: 'æŠ€èƒ½è¯ä¹¦' };
                for(const [key, title] of Object.entries(detailMap)) {
                    if(d.detail[key]) {
                        html += `<div class="detail-item"><h3>${title}</h3><ul>`;
                        const items = Array.isArray(d.detail[key]) ? d.detail[key] : [d.detail[key]];
                        items.forEach(item => { html += `<li>${item}</li>`; });
                        html += `</ul></div>`;
                    }
                }
                html += `<div class="tag-container"><span class="tag" style="border-color: ${categoryColorVar}; color: ${categoryColorVar};">${getCategoryName(d.category)}</span>`;
                if(d.also) { html += `<span class="tag" style="border-color: ${CONFIG.colors[d.also]}; color: ${CONFIG.colors[d.also]};">${getCategoryName(d.also)}</span>`; }
                html += '</div>';

                detailPanel.innerHTML = html;
                detailPanel.classList.add('visible');
                document.getElementById('close-detail-btn').onclick = (e) => { e.stopPropagation(); hideDetails(); resetFocus(); };
            }
            function hideDetails() { detailPanel.classList.remove('visible'); backdrop.classList.remove('visible'); document.body.classList.remove('panel-visible'); }
            function focusOnNode(d) {
                node.classed('is-focused', n => n.id === d.id);
                const scale = 1.2, x = -d.x * scale, y = -d.y * scale;
                svg.transition().duration(750).call(zoom.transform, d3.zoomIdentity.translate(x, y).scale(scale));
            }
            function resetFocus() {
                node.classed('is-focused', false);
                filterNodes(currentFilter); // æ¢å¤åˆ°å½“å‰ç­›é€‰çŠ¶æ€çš„é€æ˜åº¦
                link.style('stroke-opacity', null).style('stroke', null).classed('is-highlighted', false);
            }
            function filterNodes(category) {
                currentFilter = category;
                node.style('opacity', d => isVisible(d, category) ? 1 : 0.1)
                    .style('pointer-events', d => isVisible(d, category) ? 'all' : 'none');
                link.style('stroke-opacity', l => (isVisible(l.source, category) && isVisible(l.target, category)) ? 1 : 0.05);
            }

            // --- æ§ä»¶ä¸ç­›é€‰å™¨è®¾ç½® ---
            function setupControls() {
                document.getElementById('zoom-in').addEventListener('click', () => svg.transition().duration(500).call(zoom.scaleBy, 1.2));
                document.getElementById('zoom-out').addEventListener('click', () => svg.transition().duration(500).call(zoom.scaleBy, 0.8));
                document.getElementById('reset-view').addEventListener('click', () => svg.transition().duration(750).call(zoom.transform, initialTransform));
                document.getElementById('unpin-all').addEventListener('click', () => {
                    skillsData.nodes.forEach(n => { n.fx = null; n.fy = null; });
                    node.classed('is-pinned', false);
                    simulation.alpha(0.3).restart();
                });
                backdrop.addEventListener('click', () => { hideDetails(); resetFocus(); });
            }
            function setupFilters() {
                document.querySelectorAll('.filter-btn').forEach(button => {
                    button.addEventListener('click', function() {
                        document.querySelector('.filter-btn.active').classList.remove('active');
                        this.classList.add('active');
                        filterNodes(this.dataset.category);
                    });
                });
            }

            // --- è¾…åŠ©ä¸å“åº”å¼å‡½æ•° ---
            function updateViewBox() {
                width = graphContainer.clientWidth;
                height = graphContainer.clientHeight;
                svg.attr('viewBox', [-width / 2, -height / 2, width, height]);
                initialTransform = d3.zoomIdentity.translate(0, 0).scale(Math.min(width, height) / 1000); // åˆå§‹ç¼©æ”¾
                svg.call(zoom).call(zoom.transform, initialTransform);
            }
            function handleResize() { updateViewBox(); simulation.alpha(0.1).restart(); }
            function getNodeRadius(d) { return CONFIG.radii[d.type] || CONFIG.radii.leaf; }
            function getCategoryName(c) { return {'ds':'æ•°æ®ç§‘å­¦','ef':'ç»æµé‡‘è','bm':'å•†ä¸šç®¡ç†','gs':'é€šç”¨æŠ€èƒ½'}[c]||c; }
            function isVisible(d, category) {
                if (category === 'all' || d.type === 'core') return true;
                const branchMap = skillsData.links.reduce((acc, l) => { if (l.source.type === 'branch') acc[l.target.id] = l.source.category; return acc; }, {});
                return d.category === category || d.also === category || branchMap[d.id] === category;
            }
            function getHexagonPoints(r) { return Array.from({length: 6}, (_, i) => [r * Math.cos(Math.PI/3*i+Math.PI/6), r * Math.sin(Math.PI/3*i+Math.PI/6)]).map(p=>p.join(',')).join(' '); }
            function debounce(func, wait) { let timeout; return function(...args) { clearTimeout(timeout); timeout = setTimeout(() => func.apply(this, args), wait); }; }
            function wrapText(textEl, text, width) {
                textEl.each(function() {
                    let textNode = d3.select(this), words = text.replace(/-/g, '- ').split(/\s+/).reverse(), word, line = [],
                        lineNum = 0, lineHeight = 1.1, y = textNode.attr("y"), dy = parseFloat(textNode.attr("dy")),
                        tspan = textNode.text(null).append("tspan").attr("x", 0).attr("y", y).attr("dy", dy + "em");
                    while (word = words.pop()) {
                        line.push(word); tspan.text(line.join(" "));
                        if (tspan.node().getComputedTextLength() > width) {
                            line.pop(); tspan.text(line.join(" ")); line = [word];
                            tspan = textNode.append("tspan").attr("x", 0).attr("y", y).attr("dy", ++lineNum*lineHeight+dy+"em").text(word);
                        }
                    }
                    const tspans = textNode.selectAll('tspan');
                    if (tspans.size() > 1) {
                        const vOffset = -( (tspans.size() - 1) * lineHeight / 2 );
                        tspans.attr('dy', (d, i) => (parseFloat(tspans.nodes()[0].getAttribute('dy')) + vOffset + i * lineHeight) + 'em');
                    }
                });
            }
        });
    </script>
</body>
</html>
